================================================================================
                    MOODDJ BACKEND TESTING GUIDE
================================================================================

PROJECT: MoodDJ - AI-Powered Mood Detection Music Player
BACKEND: Flask + pytest Testing Framework
TOTAL TESTS: 46 tests across 8 test files
LOCATION: backend/tests/

================================================================================
                          QUICK START
================================================================================

Navigate to backend directory:
    cd C:\Users\Jpera\Desktop\MoodDJ\backend

Activate virtual environment (REQUIRED for backend):
    venv\Scripts\activate
    
You should see (venv) in your prompt

================================================================================
                     RUN ALL BACKEND TESTS
================================================================================

Best for screenshots/demos:
    python -m pytest tests/ -v

Expected Output:
    ✓ 46 tests passed
    ✓ 8 test files
    ✓ Time: ~8-10 seconds

Short summary (less verbose):
    python -m pytest tests/

With color output:
    python -m pytest tests/ -v --color=yes

================================================================================
                   RUN INDIVIDUAL TEST FILES
================================================================================

Test Main App (7 tests):
    python -m pytest tests/test_app.py -v

Test Audio Features Service (6 tests):
    python -m pytest tests/test_audio_features_service.py -v

Test Authentication Routes (6 tests):
    python -m pytest tests/test_auth_routes.py -v

Test Database (4 tests):
    python -m pytest tests/test_database.py -v

Test Mood Detector (4 tests):
    python -m pytest tests/test_mood_detector.py -v

Test Mood Routes (7 tests):
    python -m pytest tests/test_mood_routes.py -v

Test Music Routes (7 tests):
    python -m pytest tests/test_music_routes.py -v

Test Spotify Service (5 tests):
    python -m pytest tests/test_spotify_service.py -v

================================================================================
                    RUN SPECIFIC TEST CASES
================================================================================

Format:
    python -m pytest tests/FILE.py::ClassName::test_name -v

Examples:

Test only health endpoint:
    python -m pytest tests/test_app.py::TestApp::test_health_endpoint -v

Test only database connection:
    python -m pytest tests/test_database.py::TestDatabase::test_database_connection -v

Test only mood detection:
    python -m pytest tests/test_mood_routes.py::TestMoodRoutes::test_detect_mood_endpoint_success -v

Test only Spotify OAuth:
    python -m pytest tests/test_auth_routes.py::TestAuthRoutes::test_callback_endpoint_success -v

================================================================================
                    RUN TESTS WITH COVERAGE
================================================================================

Basic coverage report:
    python -m pytest tests/ --cov

Detailed HTML coverage report:
    python -m pytest tests/ --cov --cov-report=html

Then open: htmlcov/index.html in browser

Coverage for specific module:
    python -m pytest tests/ --cov=services --cov-report=term-missing

================================================================================
                        USEFUL TEST OPTIONS
================================================================================

Stop at first failure:
    python -m pytest tests/ -v -x

Show print statements:
    python -m pytest tests/ -v -s

Run only failed tests from last run:
    python -m pytest tests/ -v --lf

Run tests in parallel (faster):
    python -m pytest tests/ -v -n auto

Show test duration (slowest tests):
    python -m pytest tests/ -v --durations=10

Disable warnings:
    python -m pytest tests/ -v --disable-warnings

================================================================================
                      TEST FILE DESCRIPTIONS
================================================================================

1. test_app.py (7 tests)
   └── Tests: Main Flask app, WebSocket, CORS, health checks
   └── Validates: Server infrastructure, real-time communication
   └── Why: Ensures app responds to requests and handles errors

2. test_database.py (4 tests)
   └── Tests: MySQL connection, CRUD operations, SQL injection
   └── Validates: Data persistence, database security
   └── Why: Database is app's memory - everything depends on it

3. test_mood_detector.py (4 tests)
   └── Tests: MediaPipe facial emotion detection
   └── Validates: Happy/angry/neutral classification
   └── Why: Core feature - detects mood from camera

4. test_spotify_service.py (5 tests)
   └── Tests: Spotify API integration, mood classification
   └── Validates: OAuth, song filtering by mood
   └── Why: The "DJ" - matches songs to moods

5. test_audio_features_service.py (6 tests)
   └── Tests: RapidAPI integration for song analysis
   └── Validates: Valence, energy, tempo extraction
   └── Why: Enriches songs with mood characteristics

6. test_auth_routes.py (6 tests)
   └── Tests: Spotify OAuth flow, session management
   └── Validates: Login, logout, authentication status
   └── Why: Security - controls access to Spotify

7. test_mood_routes.py (7 tests)
   └── Tests: Mood detection API endpoints
   └── Validates: Detect, log, history, stats endpoints
   └── Why: API layer connecting frontend to mood detection

8. test_music_routes.py (7 tests)
   └── Tests: Music recommendation and playback endpoints
   └── Validates: Recommendations, play, sync endpoints
   └── Why: API layer connecting frontend to Spotify

================================================================================
                     WHAT EACH TEST VALIDATES
================================================================================

test_app.py:
  ✓ Health check endpoint (load balancer monitoring)
  ✓ WebSocket connection establishment
  ✓ Mood update broadcasting (real-time)
  ✓ Start/stop detection commands
  ✓ 404 error handling
  ✓ CORS headers for frontend communication

test_database.py:
  ✓ MySQL connection succeeds
  ✓ SELECT queries retrieve data
  ✓ INSERT/DELETE operations work
  ✓ SQL injection attacks are prevented

test_mood_detector.py:
  ✓ MediaPipe model initializes
  ✓ Handles images without faces
  ✓ Reset clears detection state
  ✓ Mood history limited to 3 frames

test_spotify_service.py:
  ✓ Service initializes with credentials
  ✓ Happy mood detection (valence > 0.6)
  ✓ Angry mood detection (valence < 0.4, energy > 0.6)
  ✓ Neutral mood detection (balanced features)
  ✓ Database queries filter by mood

test_audio_features_service.py:
  ✓ RapidAPI configuration loads
  ✓ Audio features retrieved successfully
  ✓ 404 errors handled (track not found)
  ✓ Rate limiting handled (429 errors)
  ✓ Incomplete data handled gracefully
  ✓ Service enabled check works

test_auth_routes.py:
  ✓ Login generates Spotify OAuth URL
  ✓ Callback exchanges code for token
  ✓ Missing code handled gracefully
  ✓ Auth status returns false when logged out
  ✓ Auth status returns true when logged in
  ✓ Logout clears session

test_mood_routes.py:
  ✓ Mood detection endpoint processes images
  ✓ Missing image data rejected (400 error)
  ✓ Mood logging saves to database
  ✓ Missing mood data rejected (400 error)
  ✓ Mood history retrieval works
  ✓ Mood statistics aggregation works
  ✓ Detector reset endpoint works

test_music_routes.py:
  ✓ Song recommendations based on mood
  ✓ Track playback initiates on Spotify
  ✓ Missing track ID rejected (400 error)
  ✓ Authentication required for playback (401 error)
  ✓ Current playback status retrieval
  ✓ Library sync status check
  ✓ Library sync from Spotify

================================================================================
                       EXPECTED TEST OUTPUT
================================================================================

When all tests pass, you should see:

    ============================== test session starts ==============================
    platform win32 -- Python 3.10.11, pytest-7.4.3
    collected 46 items

    tests/test_app.py::TestApp::test_health_endpoint PASSED                   [  2%]
    tests/test_app.py::TestApp::test_websocket_connect PASSED                 [  4%]
    tests/test_app.py::TestApp::test_websocket_mood_update PASSED             [  6%]
    tests/test_app.py::TestApp::test_websocket_start_detection PASSED         [  8%]
    tests/test_app.py::TestApp::test_websocket_stop_detection PASSED          [ 10%]
    tests/test_app.py::TestApp::test_404_error_handler PASSED                 [ 13%]
    tests/test_app.py::TestApp::test_cors_headers PASSED                      [ 15%]
    
    [... 39 more tests ...]

    ============================== 46 passed in 8.28s ===============================

================================================================================
                         TROUBLESHOOTING
================================================================================

"pytest: command not found" or "No module named pytest":
    → pip install pytest pytest-cov pytest-mock requests-mock

"ModuleNotFoundError: No module named 'flask'":
    → Make sure venv is activated: venv\Scripts\activate
    → pip install -r requirements.txt

Import errors:
    → Verify you're in backend/ directory
    → Check venv is activated (see "(venv)" in prompt)

Database connection errors:
    → Check MySQL is running
    → Verify .env file has correct database credentials

Tests running slowly:
    → Use parallel execution: pytest tests/ -v -n auto
    → Requires: pip install pytest-xdist

Virtual environment won't activate:
    → Try: .\venv\Scripts\activate (with dot-slash)
    → Or: venv\Scripts\activate.bat

================================================================================
                    FOR ASSIGNMENT SCREENSHOTS
================================================================================

Best command for clean output:
    python -m pytest tests/ -v

Shows:
    ✓ All test files with individual test names
    ✓ Pass/fail status with checkmarks
    ✓ Percentage completion
    ✓ Total time

Perfect for demonstrating comprehensive test coverage!

Optional: Show passing messages
    python -m pytest tests/ -v -s

================================================================================
                       COMPARISON WITH FRONTEND
================================================================================

Backend Tests:
    Location: backend/tests/
    Command: python -m pytest tests/ -v
    Total: 46 tests
    Framework: pytest
    Requires: Virtual environment (venv)
    Language: Python

Frontend Tests:
    Location: mooddj-frontend/src/__tests__/
    Command: npm test -- --watchAll=false
    Total: 15 tests
    Framework: Jest
    Requires: No virtual environment
    Language: JavaScript

Combined Total: 61 tests across full stack!

================================================================================
                         TEST ARCHITECTURE
================================================================================

Layer 1: Foundation
    └── test_database.py (4 tests)
        → MySQL connection, CRUD, security

Layer 2: Core Services
    └── test_mood_detector.py (4 tests)
        → Facial emotion detection
    └── test_spotify_service.py (5 tests)
        → Spotify integration, mood matching
    └── test_audio_features_service.py (6 tests)
        → RapidAPI song analysis

Layer 3: API Routes
    └── test_auth_routes.py (6 tests)
        → OAuth authentication endpoints
    └── test_mood_routes.py (7 tests)
        → Mood detection endpoints
    └── test_music_routes.py (7 tests)
        → Music recommendation endpoints

Layer 4: Application
    └── test_app.py (7 tests)
        → Main Flask app, WebSocket, health

Total: 46 tests covering all layers of backend architecture

================================================================================
                           QUICK REFERENCE
================================================================================

Most Common Commands:

Activate venv:          venv\Scripts\activate
Run all tests:          python -m pytest tests/ -v
Run one file:           python -m pytest tests/test_app.py -v
Run one test:           python -m pytest tests/test_app.py::TestApp::test_health_endpoint -v
With coverage:          python -m pytest tests/ --cov --cov-report=html
Stop at failure:        python -m pytest tests/ -v -x
Show prints:            python -m pytest tests/ -v -s
Parallel execution:     python -m pytest tests/ -v -n auto
Deactivate venv:        deactivate

Test File Locations:
    backend/tests/test_app.py
    backend/tests/test_audio_features_service.py
    backend/tests/test_auth_routes.py
    backend/tests/test_database.py
    backend/tests/test_mood_detector.py
    backend/tests/test_mood_routes.py
    backend/tests/test_music_routes.py
    backend/tests/test_spotify_service.py

================================================================================
                         ADDITIONAL NOTES
================================================================================

Why 46 backend tests vs 15 frontend tests?
    → Backend has more complex business logic
    → Database operations need thorough testing
    → External API integrations require validation
    → Security (SQL injection, OAuth) critical
    → Multiple layers (services, routes, database)

Test isolation:
    → Each test runs independently
    → Mocked external dependencies (Spotify, RapidAPI)
    → No actual API calls during testing
    → Fast execution despite 46 tests

Continuous Integration ready:
    → All tests pass consistently
    → No flaky tests
    → Can run in CI/CD pipelines
    → Suitable for automated testing

MediaPipe warnings:
    → "inference_feedback_manager" warnings are normal
    → Don't indicate test failures
    → Can be ignored safely

================================================================================
                           COVERAGE GOALS
================================================================================

Current Coverage:
    ✓ All services: 100% tested
    ✓ All routes: 100% tested
    ✓ Database operations: 100% tested
    ✓ Main app: 100% tested

What's tested:
    ✓ Happy path (normal flow)
    ✓ Error handling (edge cases)
    ✓ Input validation
    ✓ Security (SQL injection, authentication)
    ✓ External API integration
    ✓ Real-time communication (WebSocket)

What's NOT tested (by design):
    ✗ Actual Spotify API calls (mocked)
    ✗ Actual RapidAPI calls (mocked)
    ✗ Live MySQL operations (test database)
    ✗ Browser interaction (frontend responsibility)

================================================================================
                              END OF GUIDE
================================================================================

Last Updated: November 27, 2025
MoodDJ Capstone Project
Authors: Jeremias Peralta, Washim Akram

For frontend testing guide, see: mooddj-frontend/TEST_GUIDE.txt